<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chicago Violent Crime Map</title>
    <style type="text/css">
        #map {
            width:100%;
            height:100%;
            position: absolute;
            top: 0px;
            left: 0px;
        }
    </style>

    <!-- https://data.seattle.gov/resource/v5tj-kqhc.json?$order=distance_in_meters(location,%20%27POINT(41.8966166%20-87.6294048)%27)&$limit=5&$select=*,%20distance_in_meters(location_1,%20%27POINT(-122.3194183%2047.6145784)%27)%20AS%20range -->

    <script async src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
 
    <script type="text/javascript">

    const BAD_COLORS = ['white', 'yellow', 'orange', 'red'];

    // past years dataset: https://data.cityofchicago.org/resource/dfnk-7re6.json
    // entire data set: https://data.cityofchicago.org/resource/c4ep-ee5m.json
    // Note the dataset is a socrata API, so it supports some querying. ie. limits, pagination, filtering, ...
    // It seems Chicago hasn't updated their data set to socrata 2.1, so we can't do distance based queries like: https://dev.socrata.com/docs/functions/distance_in_meters.html
    // We're therefore forced to filter by distance on the client side, but theoretically could filter crime type server side
    // Cureently, but we currently load the whole data set to the client and do all filtering locally
    const DATASET_URL = 'https://data.cityofchicago.org/resource/dfnk-7re6.json';

    // Set map's center location. All datapoints are filtered to be <= MAX_DIST from this center point.

    // One chicago
    const LAT_LONG = [41.8966166, -87.6294048];

    // The most dangerous neighborhood
    // const LAT_LONG = [41.762901, -87.575795];

    // Lincoln park
    // const LAT_LONG = [41.921181, -87.645157]

    const MAX_DIST = 3.5; // in kilometers

    // Note: yes the city of chicago spelled description wrong in their entire dataset (only misspelled primary description)
    function violent({ _primary_decsription: _primary_description, _secondary_description, latitude, longitude }) {

        if (getDistanceFromLatLonInKm(Number(latitude), Number(longitude), ...LAT_LONG) > MAX_DIST)
            return undefined;

        const prim = _primary_description.toLowerCase();
        const sec = _secondary_description.toLowerCase();

        let badness = -1;
        let worst = false;

        if (prim.includes('battery') || prim.includes('robbery') || prim.includes('assault')) {
            badness = 0;
        } else if (prim.includes('homicide')) {
            worst = true;
        }

        if (sec.includes('gun') || sec.includes('firearm')) {
            badness += 2;
        } else if (sec.includes('dangerous weapon') || sec.includes('knife') || (sec.includes('aggravated') && !sec.includes('non-aggravated'))) {
            badness++;
        }

      
        if (worst || badness >= 0) {
            return {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: BAD_COLORS[worst ? BAD_COLORS.length - 1 : badness],
                fillOpacity: 0.6,
                strokeOpacity: 0.9,
                strokeWeight: 0,
                scale: 4
            };
        } else return undefined;
    }

    $(window).on('load', async function() {
        
        // Intialize our map
        const center = new google.maps.LatLng(...LAT_LONG);
        const mapOptions = {
          zoom: 13,
          center: center
        }
        const map = new google.maps.Map(document.getElementById("map"), mapOptions);

        function processCrimeEntry(entry) {

            const icon = violent(entry);
    
            if (icon) {
                new google.maps.Marker({
                    position: new google.maps.LatLng(entry.latitude, entry.longitude),
                    map: map,
                    // title: location.name,
                    icon
                });
            }
        }

        // Retrieve our data and plot it
        console.log('Loading data...');

        let last_len = undefined;
        let cum_len = 0;
        do {
            await new Promise(res => {
                $.getJSON(DATASET_URL + '?$offset=' + cum_len, function(data, textstatus) {
    
                    last_len = data.length;
                    cum_len += last_len;
        
                    for (const entry of data) {
                       processCrimeEntry(entry);
                    }
                    res();
                });
            });
        } while (last_len > 0 && last_len !== undefined);
        console.log(`Done querying, total dataset size: ${cum_len}`);
    });

    // from: https://stackoverflow.com/questions/18883601/function-to-calculate-distance-between-two-coordinates
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the earth in km
        const dLat = deg2rad(lat2-lat1);  // deg2rad below
        const dLon = deg2rad(lon2-lon1); 
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
          Math.sin(dLon/2) * Math.sin(dLon/2)
          ; 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        const d = R * c; // Distance in km
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }
    </script>
</head>
<body>
    <div id="map"/>
</body>
</html>